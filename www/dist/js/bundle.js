var lukkariApp=angular.module("lukkari",["ionic","lukkari.controllers","lukkari.services","ionic-datepicker"]);lukkariApp.run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}),lukkariApp.constant("ApiEndpoint",{url:"https://lukkarit.tamk.fi"}),lukkariApp.config(function(e,t){e.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"LukkariCtrl"}).state("app.search",{url:"/search",views:{menuContent:{templateUrl:"templates/search.html",controller:"SearchCtrl"}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}}}).state("app.todayAppointment",{url:"/today/:id",views:{menuContent:{templateUrl:"templates/appointment.html",controller:"AppointmentCtrl"}}}).state("app.today",{url:"/today",views:{menuContent:{templateUrl:"templates/today.html",controller:"TodayCtrl"}}}).state("app.appointment",{url:"/week/:id",views:{menuContent:{templateUrl:"templates/appointment.html",controller:"AppointmentCtrl"}}}).state("app.week",{url:"/week",views:{menuContent:{templateUrl:"templates/week.html",controller:"WeekCtrl"}}}),t.otherwise("/app/today")});var lukkariControllers=angular.module("lukkari.controllers",["ngCordova"]);lukkariControllers.controller("LukkariCtrl",function(e){}),lukkariControllers.controller("TodayCtrl",["$scope","Timetables","$ionicLoading","LocalStorage","$ionicModal","MyDate",function(e,t,o,a,r,n){e.groupInfo={},e.groupInfo.group=a.get("groupName"),e.dayOffset=0,e.currentDay="Today",r.fromTemplateUrl("templates/newgroup.html",{scope:e}).then(function(t){e.modal=t,e.groupInfo.group||e.modal.show()}),e.closeGroupName=function(){e.modal.hide()},e.setGroup=function(){a.set("groupName",e.groupInfo.group),e.modal.hide(),o.show({template:"Loading..."}),t.getDay(e.groupInfo.group,e.dayOffset,function(t){e.appointments=t,o.hide()})},e.appointments=[],void 0!==e.groupInfo.group&&(o.show({template:"Loading..."}),t.getDay(e.groupInfo.group,e.dayOffset,function(t){e.appointments=t,o.hide()})),e.moveDay=function(a){if(-1===a)e.dayOffset-=1;else{if(1!==a)throw new RangeError("Parameter out of range! Please use 1 or -1");e.dayOffset+=1}var r=n.getDayFromToday(e.dayOffset);e.currentDay=n.getLocaleDate(r,!1),o.show({template:"Loading..."}),e.appointments=[],t.getDay(e.groupInfo.group,e.dayOffset,function(t){e.appointments=t,o.hide()})}}]),lukkariControllers.controller("AppointmentCtrl",["$scope","Timetables","$ionicLoading","$stateParams",function(e,t,o,a){e.appointment=t.getAppointment(a.id)}]),lukkariControllers.controller("WeekCtrl",["$scope","Timetables","$ionicLoading","$ionicModal","LocalStorage","MyDate","Lessons",function(e,t,o,a,r,n,i){function l(){o.show({template:"Loading..."}),t.getWeek(e.groupInfo.group,e.weekOffset,function(t){var a=t;e.days=[];for(var r=n.getMonday(a[0].startDate),i=0;5>i;i++){var l={};l.date=n.getDayFromDay(r,i),l.appointments=[];for(var s=0;s<a.length;s++){var u=a[s];u.startDate.toDateString()===l.date.toDateString()&&l.appointments.push(u)}e.days.push(l)}o.hide()})}e.groupInfo={},e.week={},e.weekOffset=0,e.groupInfo.group=r.get("groupName"),e.groupInfo.group||a.fromTemplateUrl("templates/newgroup.html",{scope:e}).then(function(t){e.modal=t,e.modal.show()}),e.closeGroupName=function(){e.modal.hide()},i.get(e.groupInfo.group,function(t){t.hasOwnProperty(success)&&t.success!==!1?console.log("FAILED"):e.lessons=t}),e.setGroup=function(){r.set("groupName",e.groupInfo.group),e.modal.hide(),l()},e.appointments=[],void 0!==e.groupInfo.group&&l(),e.moveWeek=function(t){e.weekOffset+=t,l()}}]),lukkariControllers.controller("SettingsCtrl",["$scope","LocalStorage","$cordovaToast","$ionicPlatform","$cookies","$timeout","$cordovaCalendar","Timetables",function(e,t,o,a,r,n,i,l){function s(t){"undefined"==typeof t?console.log("No date selected"):(console.log("Selected date is : ",t),e.reminder.startDay=t)}e.groupInfo={},e.reminder={},e.reminder.startDay=new Date,e.reminder.weeks=1;var u={duration:"long",position:"center"};e.datepickerObject={titleLabel:"Select Date",todayLabel:"Today",closeLabel:"Close",setLabel:"Set",setButtonType:"button-positive",todayButtonType:"button-stable",closeButtonType:"button-stable",inputDate:new Date,mondayFirst:!0,templateType:"popup",showTodayButton:"true",modalHeaderColor:"bar-stable",modalFooterColor:"bar-stable",from:new Date,callback:function(e){s(e)},dateFormat:"dd-MM-yyyy",closeOnSelect:!1},e.reminder.time="null",e.groupInfo.group=t.get("groupName"),e.groupInfo.group||(e.groupInfo.group=""),e.changeGroup=function(){t.set("groupName",e.groupInfo.group),a.ready(function(){try{o.show("Group successfully changed!",u.duration,u.position).then(function(e){r.remove("PHPSESSID")})}catch(e){}finally{n(function(){window.location.href="#/app/today"},2e3)}})},e.addToCalendar=function(){function t(e){n=e,a.ready(function(){n.forEach(r(elment,index,array))})}function r(e,t,o){console.log("Added "+e.summary+", "+e.startDate.toLocaleDateString())}var n=[],i={};i.calendarName="Lukkari app calendar",i.calendarId=1,"null"!==e.reminder.time?i.firstReminderMinutes=e.reminder.time:i.firstReminderMinutes=null,i.secondReminderMinutes=null;var s=!0;console.log("$scope.reminder.weeks: "+e.reminder.weeks),console.log("$scope.reminder.startDay: "+e.reminder.startDay);for(var p=1;p<e.reminder.weeks;p++)l.getWeek(e.groupInfo.group,p,t(result));s?o.show("Calendar events successfully added!",u.duration,u.position):o.show("Failed to add calendar events!",u.duration,u.position)}}]),lukkariControllers.controller("SearchCtrl",["$scope","LocalStorage",function(e,t){}]);var lukkariServices=angular.module("lukkari.services",["ngCookies","ngIcal"]);lukkariServices.factory("LocalStorage",function(){function e(e){return window.localStorage.getItem(e)}function t(e,t){return window.localStorage.setItem(e,t)}return{get:e,set:t}}),lukkariServices.factory("MyDate",function(){function e(e){e=new Date(e);var t=e.getDay(),o=e.getDate()-t+(0===t?-6:1);return new Date(e.setDate(o))}function t(e,t){var o="";return o+=e.getDate(),o+=".",o+=e.getMonth()+1,"boolean"==typeof t&&t&&(o+=".",o+=e.getFullYear()),o}function o(e,t){var o={month:"numeric",day:"numeric"};return"boolean"==typeof t&&t&&(o.year="numeric"),new Intl.DateTimeFormat("fi-FI",o).format(e)}function a(e,t){var o=e.getTime();o+=t*n;var a=new Date;return a.setTime(o),a}function r(e){var t=Date.now();return t+=e*n,new Date(t)}var n=864e5;return{getMonday:e,formatDay:t,getDayFromToday:r,getLocaleDate:o,getDayFromDay:a}}),lukkariServices.factory("Lessons",["$http",function(e){function t(t,r){if(a===t)r(o);else{a=t;var n={studentGroup:[t.toUpperCase()]},i="Wu47zzKEPa7agvin47f5",l="https://opendata.tamk.fi/r1/reservation/search?apiKey="+i;e({method:"POST",url:l,data:n,withCredentials:!0,headers:{authorization:"Basic V3U0N3p6S0VQYTdhZ3ZpbjQ3ZjU6","accept-language":"fi","content-type":"application/json","cache-control":"no-cache"}}).success(function(e,t,o,a){console.log(e.reservations),r(e.reservations)}).error(function(e,t,o,a){r({success:!1})})}}var o=[],a="";return{get:t}}]),lukkariServices.factory("Timetables",["$http","ical","$cookies","ApiEndpoint","MyDate",function(e,t,o,a,r){function n(){var e=new t.Component(["vcalendar",[],[]]);e.updatePropertyWithValue("prodid","-//Lukkari generated calendar");for(var o=0;o<d.length;o++){var a=new t.Component("vevent"),r=new t.Event(a);r.summary=d[o].summary+" "+d[o].courseNumber,r.status="ACCEPTED",r.organizer=d[o].teacher,r.location=d[o].location,a.addPropertyWithValue("dtstart",t.Time.fromJSDate(d[o].startDate)),a.addPropertyWithValue("dtend",t.Time.fromJSDate(d[o].endDate));var n=new t.Component("valarm");n.addPropertyWithValue("trigger","-PT10M"),n.addPropertyWithValue("action","DISPLAY"),n.addPropertyWithValue("description","Reminder"),a.addSubcomponent(n),e.addSubcomponent(a)}return e.toString()}function i(t,n,i,l){d=[],o.remove("PHPSESSID"),e({method:"GET",url:a.url+"/paivitaKori.php?toiminto=addGroup&code="+t.toUpperCase(),withCredentials:!0}).then(function(t){e({method:"GET",url:a.url+"/icalcreator.php?startDate="+r.formatDay(n,!0)+"&endDate="+r.formatDay(i,!0)}).then(function(e){for(var t=p(e.data),o=0;o<t.length;o++){var a=u(t[o],o);d.push(a)}l(d)})})}function l(e,t,o){var a=r.getMonday(new Date),n=r.getDayFromDay(a,6*t),l=r.getDayFromDay(n,6);i(e,n,l,o)}function s(e,t,o){var a=r.getDayFromToday(t);i(e,a,a,o)}function u(e,o){var a={},r=new t.Event(e);a.summary=r.summary.split(/[0-9]+/)[0],a.courseNumber=r.summary.slice(a.summary.length),a.location=r.location.split(" - ")[0];try{a.locationInfo=r.location.slice(a.location.length+2).split(", ")[0],a.locationInfo2=r.location.slice(a.location.length+2).split(", ")[1]}catch(n){a.locationInfo=r.location}try{a.teacher=r.description.split(/Henkilö\(t\): /)[1].split(/Ryhmä\(t\): /)[0],a.teacher=a.teacher}catch(n){a.teacher=r.description}try{a.groups=r.description.slice(r.description.split(/Ryhmä\(t\): /)[0].length).split(/Ryhmä\(t\): /)[1]}catch(n){a.groups=r.description}a.groups=a.groups;for(var i in a)a[i]=a[i].trim();return a.id=o,a.startDate=r.startDate.toJSDate(),a.endDate=r.endDate.toJSDate(),a.day=r.startDate.dayOfWeek()-2,a}function p(e){var o=t.parse(e),a=new t.Component(o);return a.getAllSubcomponents()}function c(e){return d[e]}var d=[];return{getWeek:l,getAppointment:c,getDay:s,toICAL:n}}]);
//# sourceMappingURL=bundle.js.map

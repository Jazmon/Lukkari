"use strict";angular.module("lukkari",["ionic","lukkari.controllers","lukkari.services","lukkari.directives","ionic-datepicker","ionic-material","angularXml2json"]).run(["$ionicPlatform",function($ionicPlatform){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]).constant("ApiEndpoint",{url:"http://localhost:8100/api"}).constant("LunchEndPoint",{url:"http://localhost:8100/lunch"}).config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"LukkariCtrl"}).state("app.search",{url:"/search",views:{menuContent:{templateUrl:"templates/search.html",controller:"SearchCtrl"}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}}}).state("app.todayLesson",{url:"/today/:id",views:{menuContent:{templateUrl:"templates/lesson.html",controller:"LessonCtrl"}}}).state("app.today",{url:"/today",views:{menuContent:{templateUrl:"templates/today.html",controller:"TodayCtrl"}}}).state("app.lesson",{url:"/week/:id",views:{menuContent:{templateUrl:"templates/lesson.html",controller:"LessonCtrl"}}}).state("app.week",{url:"/week",views:{menuContent:{templateUrl:"templates/week.html",controller:"WeekCtrl"}}}).state("app.lunch",{url:"/lunch",views:{menuContent:{templateUrl:"templates/lunch.html",controller:"LunchCtrl"}}}),$urlRouterProvider.otherwise("/app/today")}]),angular.module("lukkari.services",[]),angular.module("lukkari.controllers",["ngCordova"]),angular.module("lukkari.directives",[]),angular.module("lukkari.services").factory("FoodService",["$http","LunchEndPoint","ngXml2json",function($http,LunchEndPoint,ngXml2json){function parseLunch(element,index,array){for(var lunch={date:new Date(element.div[0].span.content[0]),dishes:[]},length=element.div[1].div.length-3,i=0;length>i;i++){var dish={};dish.pricegroups=[],dish.allergies=[],dish.name=element.div[1].div[i].div.div.ul.li.div.div.div[0].div.div.content,dish.name.includes("Ravintola avoinna")||lunch.dishes.push(dish)}lunches.push(lunch)}function get(_ref){var callback=_ref.callback;lunches.length>0?callback(lunches):$http({method:"GET",url:["https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%2","0html%20where%20url%3D%22http%3A%2F%2Fcampusravita.fi%2Fruokali","sta%22%20and%0A%20%20%20%20%20%20xpath%3D'%2F%2Fdiv%5B%40class%","3D%22view-grouping%22%5D'&format=json&diagnostics=true&callback="].join("")}).then(function(response){var data=response.data.query.results.div;data.forEach(parseLunch),callback(lunches)},function(response){})}var lunches=[];return{get:get}}]),angular.module("lukkari.services").factory("Lessons",["$http","ApiEndpoint","MyDate",function($http,ApiEndpoint,MyDate){function parseLesson(element,index,array){var lesson={};lesson.id=index,lesson.startDay=new Date(element.startDate),lesson.endDay=new Date(element.endDate),lesson.groups=[];var resources=element.resources;resources.forEach(function(resource,index,array){switch(resource.type){case"realization":lesson.code=resource.code,lesson.name=resource.name;break;case"room":lesson.room=resource.code,lesson.roomInfo=resource.parent.name;break;case"student_group":lesson.groups.push(resource.code)}}),lessons.push(lesson)}function get(callback){var data={studentGroup:[savedGroupName]},apiKey="Wu47zzKEPa7agvin47f5",url=[ApiEndpoint.url,"/reservation/search","?apiKey=",apiKey].join("");$http({method:"POST",url:url,data:data,withCredentials:!0,headers:{authorization:"Basic V3U0N3p6S0VQYTdhZ3ZpbjQ3ZjU6","accept-language":"fi","content-type":"application/json","cache-control":"no-cache"}}).success(function(data,status,headers,config){lessons=[],data.reservations.forEach(parseLesson),callback({success:!1})}).error(function(data,status,headers,config){console.error("Failed to get lesson data!"),callback({success:!1})})}function changeGroup(_ref){var groupName=_ref.groupName,callback=_ref.callback;savedGroupName=groupName.toUpperCase(),get(function(result){callback(result)})}function getDay(_ref2){var callback=_ref2.callback,day=_ref2.day;if(!day||!day instanceof Date)console.error("Error in date!"),callback({success:!1});else{var dayLessons=[];lessons.forEach(function(lesson,index,array){var date=lesson.startDay;date.getDate()===day.getDate()&&date.getMonth()===day.getMonth()&&dayLessons.push(lesson)}),callback({success:!0,dayLessons:dayLessons})}}function getWeek(_ref3){function checkLessonDate(lesson,index,array){lesson.startDay>=startDate&&lesson.startDay<=endDate&&weekLessons.push(lesson)}var callback=_ref3.callback,day=_ref3.day,weekLessons=[],startDate=new Date(day.getFullYear(),day.getMonth(),day.getDate()),endDate=MyDate.getDayFromDay({currentDay:day,offsetDays:5});lessons.forEach(checkLessonDate),callback({success:!0,weekLessons:weekLessons})}function getDayToDay(_ref4){var callback=_ref4.callback,startDate=_ref4.startDate,endDate=_ref4.endDate,correctEndDate=MyDate.getDayFromDay({currentDay:endDate,offsetDays:1}),retLessons=[];lessons.forEach(function(lesson,index,array){lesson.startDay>=startDate&&lesson.startDay<=correctEndDate&&retLessons.push(lesson)}),callback({success:!0,lessons:retLessons})}function getLesson(id){return lessons[id]}var lessons=[],savedGroupName=void 0;return{changeGroup:changeGroup,getDay:getDay,getWeek:getWeek,getDayToDay:getDayToDay,getLesson:getLesson}}]),angular.module("lukkari.services").factory("LocalStorage",[function(){function get(name){return window.localStorage.getItem(name)}function set(name,value){return window.localStorage.setItem(name,value)}return{get:get,set:set}}]),angular.module("lukkari.services").factory("MyDate",[function(){function getMonday(d){d=new Date(d);var day=d.getDay(),diff=d.getDate()-day+(0===day?-6:1);return new Date(d.setDate(diff))}function getLocaleDate(_ref){var day=_ref.day,years=_ref.years,options={month:"numeric",day:"numeric"};return"boolean"==typeof years&&years&&(options.year="numeric"),new Intl.DateTimeFormat("fi-FI",options).format(day)}function getDayFromDay(_ref2){var currentDay=_ref2.currentDay,offsetDays=_ref2.offsetDays,day=currentDay.getTime();day+=offsetDays*DAY_IN_MILLISECONDS;var date=new Date;return date.setTime(day),date}function getDayFromToday(offsetDays){var day=Date.now();return day+=offsetDays*DAY_IN_MILLISECONDS,new Date(day)}var DAY_IN_MILLISECONDS=864e5;return{getMonday:getMonday,getDayFromToday:getDayFromToday,getLocaleDate:getLocaleDate,getDayFromDay:getDayFromDay}}]),angular.module("lukkari.directives").directive("date",function(){return{template:['{{day.date.toLocaleDateString("fi-FI",',' {weekday: "short", day: "numeric", month:"numeric"})}}'].join("")}}),angular.module("lukkari.directives").directive("ngLastRepeat",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("ngLastRepeat"+(attr.ngLastRepeat?"."+attr.ngLastRepeat:""))})}}}),angular.module("lukkari.directives").directive("timeRange",function(){return{template:["{{lesson.startDay.toLocaleTimeString",'("fi-FI", {hour:"numeric", minute:"numeric"})}}'," â€” {{lesson.endDay.toLocaleTimeString",'("fi-FI", {hour:"numeric", minute:"numeric"})}}'].join("")}}),angular.module("lukkari.controllers").controller("LessonCtrl",["$scope","$ionicLoading","$stateParams","Lessons","ionicMaterialInk","ionicMaterialMotion",function($scope,$ionicLoading,$stateParams,Lessons,ionicMaterialInk){$scope.lesson=Lessons.getLesson($stateParams.id),ionicMaterialInk.displayEffect()}]),angular.module("lukkari.controllers").controller("LukkariCtrl",["$scope",function($scope){}]),angular.module("lukkari.controllers").controller("LunchCtrl",["$scope","FoodService","ionicMaterialInk","ionicMaterialMotion","$ionicLoading",function($scope,FoodService,ionicMaterialInk,ionicMaterialMotion,$ionicLoading){$ionicLoading.show({templateUrl:"templates/loading.html"}),FoodService.get({callback:function(lunches){$scope.lunches=lunches,$ionicLoading.hide()}}),$scope.$on("ngLastRepeat.myList",function(e){ionicMaterialMotion.ripple()}),ionicMaterialInk.displayEffect()}]),angular.module("lukkari.controllers").controller("SearchCtrl",["$scope","LocalStorage",function($scope,LocalStorage){}]),angular.module("lukkari.controllers").controller("SettingsCtrl",["$scope","LocalStorage","$cordovaToast","$ionicPlatform","$timeout","$cordovaCalendar","Lessons","MyDate","ionicMaterialInk","ionicMaterialMotion",function($scope,LocalStorage,$cordovaToast,$ionicPlatform,$timeout,$cordovaCalendar,Lessons,MyDate,ionicMaterialInk,ionicMaterialMotion){function datePickerCallback(val){"undefined"==typeof val||($scope.reminder.startDay=val,$scope.datepickerObject.inputDate=val)}function datePickerCallback2(val){"undefined"==typeof val||($scope.reminder.endDay=val,$scope.datepickerObject2.inputDate=val)}$scope.groupInfo={},$scope.reminder={},$scope.reminder.startDay=new Date,$scope.reminder.endDay=new Date;var toastOptions={duration:"long",position:"center"};$scope.datepickerObject={titleLabel:"Select Start Date",todayLabel:"Today",closeLabel:'<span class="icon ion-android-close"></span>',setLabel:'<span class="icon ion-android-done"></span>',setButtonType:"button-positive",todayButtonType:"button-stable",closeButtonType:"button-assertive",inputDate:$scope.reminder.startDay,mondayFirst:!0,templateType:"popup",showTodayButton:"true",modalHeaderColor:"bar-stable",modalFooterColor:"bar-stable",from:new Date,callback:function(val){datePickerCallback(val)},dateFormat:"dd-MM-yyyy",closeOnSelect:!0},$scope.datepickerObject2={titleLabel:"Select End Date",todayLabel:"Today",closeLabel:'<span class="icon ion-android-close"></span>',setLabel:'<span class="icon ion-android-done"></span>',setButtonType:"button-positive",todayButtonType:"button-stable",closeButtonType:"button-assertive",inputDate:$scope.reminder.endDay,mondayFirst:!0,templateType:"popup",showTodayButton:!1,modalHeaderColor:"bar-positive",modalFooterColor:"bar-positive",from:new Date,callback:function(val){datePickerCallback2(val)},dateFormat:"dd-MM-yyyy",closeOnSelect:!0},$scope.reminder.time="null",$scope.groupInfo.group=LocalStorage.get("groupName"),$scope.groupInfo.group||($scope.groupInfo.group=""),$scope.changeGroup=function(){LocalStorage.set("groupName",$scope.groupInfo.group),$ionicPlatform.ready(function(){$cordovaToast.show("Group successfully changed!",toastOptions.duration,toastOptions.position),$timeout(function(){window.location.href="#/app/today"},2e3)})},$scope.addToCalendar=function(){function createEvent(element,index,array){for(var groups="",i=0;i<element.groups.length;i++)groups+=element.groups[i]+", ";$cordovaCalendar.createEventWithOptions({title:element.name,location:element.room,notes:"Teacher(s): "+element.teacher+"\nGroup(s): "+groups+"\nCourse: "+element.code,startDate:element.startDay,endDate:element.endDay,firstReminderMinutes:calOptions.firstReminderMinutes,secondReminderMinutes:calOptions.secondReminderMinutes,calendarName:calOptions.calendarName,calendarId:calOptions.calendarId}).then(function(result){},function(err){success=!1})}var calOptions={calendarName:"Lukkari app calendar",calendarId:1};"null"!==$scope.reminder.time?calOptions.firstReminderMinutes=$scope.reminder.time:calOptions.firstReminderMinutes=null,calOptions.secondReminderMinutes=null;var success=!0;Lessons.getDayToDay({startDate:$scope.reminder.startDay,endDate:$scope.reminder.endDay,callback:function(response){$ionicPlatform.ready(function(){response.lessons.forEach(createEvent)})}});var msg="";msg=success?"Calendar events successfully added!":"Failed to add calendar events!",$cordovaToast.show(msg,toastOptions.duration,toastOptions.position),console.log(msg)},ionicMaterialMotion.ripple(),ionicMaterialInk.displayEffect()}]),angular.module("lukkari.controllers").controller("TodayCtrl",["$scope","$ionicLoading","LocalStorage","$ionicModal","MyDate","Lessons","ionicMaterialInk","ionicMaterialMotion",function($scope,$ionicLoading,LocalStorage,$ionicModal,MyDate,Lessons,ionicMaterialInk,ionicMaterialMotion){function getAppointments(){$ionicLoading.show({templateUrl:"templates/loading.html"}),Lessons.getDay({day:$scope.currentDay,callback:function(response){$ionicLoading.hide(),response.success?$scope.lessons=response.dayLessons:console.error("ERROR")}})}$scope.groupInfo={group:LocalStorage.get("groupName")},$scope.currentDay=new Date,$ionicModal.fromTemplateUrl("templates/newgroup.html",{scope:$scope}).then(function(modal){$scope.modal=modal,$scope.groupInfo.group||$scope.modal.show()}),$scope.closeGroupName=function(){$scope.modal.hide()},$scope.$on("ngLastRepeat.myList",function(e){ionicMaterialMotion.blinds()}),$scope.setGroup=function(){LocalStorage.set("groupName",$scope.groupInfo.group),$scope.modal.hide(),Lessons.changeGroup({groupName:$scope.groupInfo.group,callback:function(success){success?getAppointments():console.error("failed to change group name")}})},$scope.lessons=[],void 0!==$scope.groupInfo.group&&null!==$scope.groupInfo.group&&Lessons.changeGroup({groupName:$scope.groupInfo.group,callback:function(success){success?getAppointments():console.error("failed to change group name")}}),$scope.moveDay=function(direction){$scope.currentDay=MyDate.getDayFromDay({currentDay:$scope.currentDay,offsetDays:direction}),getAppointments()},ionicMaterialInk.displayEffect()}]),angular.module("lukkari.controllers").controller("WeekCtrl",["$scope","$ionicLoading","$ionicModal","LocalStorage","MyDate","Lessons","ionicMaterialInk","ionicMaterialMotion",function($scope,$ionicLoading,$ionicModal,LocalStorage,MyDate,Lessons,ionicMaterialInk,ionicMaterialMotion){function getAppointments(){$ionicLoading.show({templateUrl:"templates/loading.html"}),Lessons.getWeek({day:$scope.currentDate,callback:function(response){if($ionicLoading.hide(),response.success){var allLessons=response.weekLessons;$scope.days=[];for(var i=0;5>i;i++){var day={};day.date=MyDate.getDayFromDay({currentDay:$scope.currentDate,offsetDays:i}),day.lessons=[];for(var lessonsLength=allLessons.length,j=0;lessonsLength>j;j++){var lesson=allLessons[j];lesson.startDay.toDateString()===day.date.toDateString()&&day.lessons.push(lesson)}$scope.days.push(day)}}else console.error("ERROR")}}),$ionicLoading.hide()}$scope.groupInfo={group:LocalStorage.get("groupName")},$scope.currentDate=MyDate.getMonday(new Date),$scope.endDate=MyDate.getDayFromDay({currentDay:$scope.currentDate,offsetDays:4}),$scope.groupInfo.group||$ionicModal.fromTemplateUrl("templates/newgroup.html",{scope:$scope}).then(function(modal){$scope.modal=modal,$scope.modal.show()}),$scope.closeGroupName=function(){$scope.modal.hide()},$scope.$on("ngLastRepeat.myList",function(e){ionicMaterialMotion.ripple()}),$scope.setGroup=function(){LocalStorage.set("groupName",$scope.groupInfo.group),$scope.modal.hide(),Lessons.changeGroup({groupName:$scope.groupInfo.group,callback:function(success){success?getAppointments():console.error("failed to change group name")}})},$scope.lessons=[],void 0!==$scope.groupInfo.group&&Lessons.changeGroup({groupName:$scope.groupInfo.group,callback:function(success){success?getAppointments():console.error("failed to change group name")}}),$scope.moveWeek=function(direction){$scope.currentDate=MyDate.getDayFromDay({currentDay:$scope.currentDate,offsetDays:7*direction}),$scope.endDate=MyDate.getDayFromDay({currentDay:$scope.currentDate,offsetDays:4}),getAppointments()},ionicMaterialInk.displayEffect()}]);
//# sourceMappingURL=bundle.min.js.map
